/*
 * RTC.c
 *
 *  Created on: 07/06/2016
 *      Author: Red
 */

#define mask_SEC    0x3F
#define mask_MIN	0x3F00
#define mask_HOUR 	0x1F0000
#define mask_DOM    0X1F
#define mask_DOW    0X7000000
#define mask_DOY	0XFFF
#define mask_MONTH  0XF00
#define mask_YEAR	0XFFF0000


/* Faz a iniciação do sistema para permitir o acesso ao periférico RTC. O RTC é
iniciado com os valores do parâmetro. */
void RTC_Init(struct tm *dateTime) {
	PCONP |= (1 << 9);
	RTC.CCR = 0x2; /* Disable time counters and reset CTC */
	RTC.PREINT = (LPC2106_PCLK  / 32768) - 1; /* Set PREINT */
	RTC.PREFRAC = LPC2106_PCLK  - ((RTC.PREINT + 1) * 32768); /* Set PREFRAC */
	RTC.ILR = 0x3; /* Clear interrupts */
	RTC.ILR = 0x0; /* Disable interrupts */
	RTC.CIIR = 0x0; /* CIIR disabled */
	RTC.AMR = 0xFF; /* Alarm disabled */
	RTC_SetValue(dateTime);
	RTC.CCR = 0x1; /* Enable time counters and CTC */
}

/* Realiza a atualização do RTC com os valores do parâmetro dateTime. */
void RTC_SetValue(struct tm *dateTime){
	RTC.CCR = 0x2; /* Disable time counters and reset CTC */
    RTC.SEC = dateTime-> 	tm_sec;
    RTC.MIN = dateTime-> 	tm_min;
    RTC.HOUR = dateTime-> 	tm_hour;
    RTC.DOM = dateTime-> 	tm_mday;
    RTC.MONTH = dateTime-> 	tm_mon;
    RTC.YEAR = dateTime-> 	tm_year;
    RTC.DOW = dateTime-> 	tm_wday;
    RTC.DOY = dateTime-> 	tm_yday;
    RTC.CCR = 0x1; /* Enable time counters and CTC */
}



/* Devolve em dateTime o valor corrente do RTC. */
void RTC_GetValue(struct tm *dateTime){
   dateTime-> tm_sec   =  RTC.CTIME0 & mask_SEC;         	/* seconds,  range 0 to 59          */
   dateTime-> tm_min   = (RTC.CTIME0 & mask_MIN) 	>> 8 ;	/* minutes, range 0 to 59           */
   dateTime-> tm_hour  = (RTC.CTIME0 & mask_MIN) 	>> 16;	/* hours, range 0 to 23             */
   dateTime-> tm_mday  =  RTC.CTIME1 & mask_DOM;        	/* day of the month, range 1 to 31  */
   dateTime-> tm_mon   = (RTC.CTIME1 & mask_MONTH) 	>> 8 ;	/* month, range 0 to 11             */
   dateTime-> tm_year  = (RTC.CTIME1& mask_YEAR) 	>> 16;	/* The number of years since 1900   */
   dateTime-> tm_wday  = (RTC.CTIME0 & mask_DOW) 	>> 24;	/* day of the week, range 0 to 6    */
   dateTime-> tm_yday  = (RTC.CTIME2 & mask_DOY);        	/* day in the year, range 0 to 365  */
}
